#!/usr/bin/env node
"use strict";var e=require("commander"),t=require("shelljs"),s=require("fs"),a=require("colors"),r=require("slash"),i=require("cosmiconfig");function c(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=c(t),o=c(s),l=c(a),u=c(r);const g={command:"get",short:"gt",args:[{required:!1,name:"message",variadic:!1,validator:(e,t,s)=>{/\s+/.test(e)?s(new Error("请不要输入空格")):s()},description:"存取关键字"},{required:!1,name:"index",variadic:!1,description:"序号"}],options:[{flags:"-k, --keep [keep]",required:!1,optional:!1,variadic:!1,mandatory:!1,short:"-k",long:"--keep",negate:!1,description:"保留暂存区不删除",defaultValue:!1}],validatorOpts:(e,t,s)=>{s()},validatorArgs:(e,t,s)=>{s()},transformOpts:(e,t,s)=>{s()},transformArgs:(e,t,s)=>{s()}},f=g.args,p=g.options;function d(e=process.cwd()){const t=n.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[s,a,r,i,c=""]=t.split("\n").map((e=>e.trim())).map(u.default);return{prefix:a||".",gitCommonDir:r,root:s,gitDir:i,gitHookDir:i+"/hooks",cdup:c}}const m={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};function h(e,t="gitmars"){let s;if(!e){let{root:t}=d();try{e=t+"/gitmarsconfig.json",s=o.default.statSync(e)}catch(s){e=t}}const a={skipCI:!0},r=i.cosmiconfigSync(t);if(s||(s=o.default.statSync(e)),s.isDirectory()){const{config:t={},filepath:s=""}=r.search(e)||{};return Object.assign({},m,a,t,{filepath:s})}{const{config:t={},filepath:s=""}=r.load(e)||{};return Object.assign({},m,a,t,{filepath:s})}}function k(e){return l.default.yellow(e)}function b(e){return l.default.red(e)}function y(e,t){0!==e.length?t(e[0],((s=!1)=>{s||(e.shift(),y(e,t))})):t()}function v(e){return new Promise(((t,s)=>{let a=[];0===e.length&&s("指令名称不能为空"),y(e=JSON.parse(JSON.stringify(e)),((s,r)=>{let i={silent:!0,postmsg:!1,kill:!0,again:!1},c=s;s instanceof Object&&(i=Object.assign(i,s.config||{}),c=s.cmd),c?n.default.exec(c,i,((t,o,u)=>{let g=function(e){let t={},s=e.replace(/[\s]+/g," ").split(" ");if(s.length<2||"git"!==s[0])return t;switch(s[1]){case"checkout":t.success="切换分支成功",t.fail="切换分支失败";break;case"pull":t.success="拉取代码成功",t.fail="拉取代码失败";break;case"fetch":t.success="抓取成功",t.fail="抓取失败";break;case"commit":t.success="提交成功",t.fail="提交失败";break;case"push":t.success="推送成功",t.fail="推送失败";break;case"cherry-pick":t.success="同步提交记录成功",t.fail="同步提交记录失败";break;case"merge":t.success="merge分支成功",t.fail="merge分支失败";break;case"rebase":t.success="rebase分支成功",t.fail="rebase分支失败";break;case"revert":t.success="撤销成功",t.fail="撤销失败";break;case"clean":t.success="清理成功",t.fail="清理失败"}return t}(c);try{o=JSON.parse(o)}catch(u){o=o.replace(/\n*$/g,"")}if(a.push({code:t,out:o,err:u,cfg:i,cmd:c}),0!==t&&function(e){const{gitDir:t}=d();n.default.touch(t+"/.gitmarslog"),n.default.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(e)),t+"/.gitmarslog")}({command:s,code:t,out:o,err:u}),0!==t&&i.kill){let t=JSON.parse(JSON.stringify(e));i.again?!0!==i.again&&t.splice(0,1,i.again):t.shift(),r(!0),function(e){const{gitDir:t}=d();n.default.touch(t+"/.gitmarscommands"),n.default.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(e)),t+"/.gitmarscommands")}(t),i.silent&&n.default.echo(b(u)),n.default.echo(b(i.fail||g.fail||"出错了！指令 "+c+" 执行失败，中断了进程")),i.postmsg&&x("出错了！指令 "+c+" 执行失败，中断了进程"),t.length>0&&n.default.echo(b("请处理相关问题之后输入gitm continue继续")),n.default.exit(1)}else{if(0===t){let e=i.success||g.success;e&&(n.default.echo((f=e,l.default.green(f))),i.postmsg&&x(e))}else{let e=i.fail||g.fail||"指令 "+c+" 执行失败";e&&n.default.echo(k(e))}r()}var f})):t(a)}))}))}function $(e){const{root:t}=d(),{appName:s}=function(e=process.cwd()){const t=n.default.exec("git config --local --get remote.origin.url",{silent:!0}).stdout.replace(/[\s]*$/g,""),[s]=t.split("\n").map((e=>e.trim())).map(u.default);return{gitUrl:s,appName:s.replace(/^[\s\S]+\/([a-z0-9A-Z-_]+)\.git$/,"$1")}}(),a=h();let r="",i=new Date;switch(e){case"time":r=i;break;case"timeNum":r=i.getTime();break;case"pwd":r=t;break;case"project":r=s;break;case"user":r=a.user}return r}function x(e=""){const t=h();if(!t.msgTemplate)return void n.default.echo(b("请配置消息发送api模板地址"));let s=(a=t.msgTemplate,r=t=>"message"===t?e:$(t),a&&r?""+a.replace(/\$\{([a-zA-Z0-9-_]+)\}/g,((e,t)=>{if("function"==typeof r)return r(t);for(let e in r)if(t===e)return r[e]})):null);var a,r;t.msgUrl&&function(e="",t={}){const s=h(),{silent:a=!0}=t;if(!s.msgUrl)return void n.default.echo(b("请配置消息推送地址"));e=e.replace(/\s/g,""),s.msgUrl&&n.default.exec(`curl -i -H "Content-Type: application/json" -X POST -d '{"envParams":{"error_msg":"'${e}'"}}' "${s.msgUrl}"`,{silent:a})}(s)}n.default.exec("git rev-parse --is-inside-work-tree",{silent:!0}).stdout.includes("true")||(n.default.echo(b("当前目录不是git项目目录")),n.default.exit(1)),e.program.name("gitm get").usage("[message] [index]").description("恢复暂存区文件"),f.length>0&&e.program.arguments(function(e){let t=[];return e.forEach((e=>{let s=e.name;e.variadic&&(s+="..."),s=e.required?"<"+s+">":"["+s+"]",t.push(s)})),t.join(" ")}(f)),p.forEach((t=>{e.program.option(t.flags,t.description,t.defaultValue)})),e.program.action((async(e,t,s)=>{e||(e=n.default.exec("git symbolic-ref --short -q HEAD",{silent:!0}).stdout.replace(/[\n\s]*$/g,""));let a=await async function(e){const t=(await v(["git stash list"]))[0].out.replace(/^\*\s+/,"");let s=t&&t.split("\n")||[],a=[];s.length>10&&n.default.echo(k(`该项目下一共有${s.length}条暂存记录，建议定期清理！`));try{s.forEach((t=>{let s=t.split(":"),r=s.shift();if(!e||e&&e===s[s.length-1].trim()){let e=r.match(/^stash@\{(\d+)\}$/);s.length>1&&s.shift(),a.push({key:r,index:+e[1],msg:s.join(":").trim()})}}))}catch(e){}return a}(e);0===a.length&&n.default.echo(k("该分支没有暂存任何文件！")),void 0===t&&a.length>1&&n.default.echo(k(`该分支下有${a.length}条暂存记录，默认恢复最近的一条记录`)),a.length>2&&n.default.echo(k(`该分支下有${a.length}条暂存记录，建议定期清理不必要的暂存记录！`)),v([{cmd:`git stash ${s.keep?"apply":"pop"} ${a[t||0].key}`,config:{again:!s.keep&&`git stash drop ${a[t||0].key}`,success:"文件恢复成功",fail:"恢复失败，请检查冲突"}}])})),e.program.parse(process.argv);
