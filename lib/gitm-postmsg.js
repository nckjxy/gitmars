#!/usr/bin/env node
"use strict";var t=require("commander"),e=require("shelljs"),i=require("path"),r=require("fs"),o=require("colors"),n=require("slash"),a=require("cosmiconfig");function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var l=s(e),u=s(i),c=s(r),f=s(o),g=s(n);const p=[{required:!0,name:"message",variadic:!1}],d=[{flags:"-u, --url [url]",required:!1,optional:!0,variadic:!1,mandatory:!1,short:"-u",long:"--url",negate:!1,description:"推送消息的api地址",defaultValue:""}];const m={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};function h(t,e="gitmars"){let i;if(!t){let{root:e}=function(t=process.cwd()){const e=l.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[i,r,o,n,a=""]=e.split("\n").map((t=>t.trim())).map(g.default);return{prefix:r||".",gitCommonDir:o,root:i,gitDir:n,gitHookDir:n+"/hooks",cdup:a}}();try{t=e+"/gitmarsconfig.json",i=c.default.statSync(t)}catch(i){t=e}}const r={skipCI:!0},o=a.cosmiconfigSync(e);if(i||(i=c.default.statSync(t)),i.isDirectory()){const{config:e={},filepath:i=""}=o.search(t)||{};return Object.assign({},m,r,e,{filepath:i})}{const{config:e={},filepath:i=""}=o.load(t)||{};return Object.assign({},m,r,e,{filepath:i})}}function C(t){return f.default.red(t)}function j(t,e){return new Promise(((i,r)=>{c.default.writeFile(t,e,(t=>{t?r(new Error("文件写入错误")):i(!0)}))}))}let y=require("node-apollo"),q=require("shelljs");const v=u.default.join(__dirname,"../../cache");async function w(t,e={}){const i=await async function(){let t,e,i,r=(new Date).getTime();if(q.test("-f",v+"/buildConfig.json")&&r-parseInt(q.cat(v+"/buildConfig.txt").stdout)<864e5)return require(v+"/buildConfig.json");if(t=h(),!t.apolloConfig)return q.echo(C("请配置apollo")),void q.exit(0);if("string"==typeof t.apolloConfig)try{e=JSON.parse(t.apolloConfig)}catch{return}else e=t.apolloConfig;return i=await y.remoteConfigService(e),await j(v+"/buildConfig.txt",String(r)),await j(v+"/buildConfig.json",JSON.stringify(i.content)),i.content}(),{silent:r=!0,url:o}=e;let n=[];i.gitNotificationGroupUrl||o?(o?n=[o]:i.gitNotificationGroupUrl&&(n="string"==typeof i.gitNotificationGroupUrl?[i.gitNotificationGroupUrl]:i.gitNotificationGroupUrl),t=t.replace(/\s/g,""),n.forEach((()=>{l.default.exec(`curl -i -H "Content-Type: application/json" -X POST -d "{\\"content\\":\\"${t}\\"}" "${o||i.gitNotificationGroupUrl}"`,{silent:r})}))):l.default.echo(C("没有配置群消息推送地址"))}t.program.name("gitm postmsg").usage("<message> [-u --url [url]]").description("发送群消息消息"),p.length>0&&t.program.arguments(function(t){let e=[];return t.forEach((t=>{let i=t.name;t.variadic&&(i+="..."),i=t.required?"<"+i+">":"["+i+"]",e.push(i)})),e.join(" ")}(p)),d.forEach((e=>{t.program.option(e.flags,e.description,e.defaultValue)})),t.program.action(((t,e)=>{w(function(t){let e=[];for(var i=0;i<t.length;i++)e[i]=("00"+t.charCodeAt(i).toString(16)).slice(-4);return"\\u"+e.join("\\u")}(t),{url:e.url||""})})),t.program.parse(process.argv);
