#!/usr/bin/env node
"use strict";var e=require("commander"),a=require("shelljs");require("fs");var r=require("colors");function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("slash"),require("cosmiconfig");var i=t(a),n=t(r);const s=[{required:!1,name:"branche",variadic:!1}],c=[{flags:"--latest [latest]",required:!1,optional:!1,variadic:!1,mandatory:!1,short:"",long:"--latest",negate:!1,description:"查询在某个时间之后的日志，填写格式：10s/2m/2h/3d/4M/5y",defaultValue:"7d"},{flags:"--limit [limit]",required:!1,optional:!1,variadic:!1,mandatory:!1,short:"",long:"--limit",negate:!1,description:"最多查询的日志条数",defaultValue:20}];function l(e={}){const{lastet:a,limit:r,branches:t}=e,n=["%H","%T","%P","%an","%ae","%al","%aL","%ad","%ar","%at","%aI","%as","%cn","%ce","%cl","%cL","%cd","%cr","%ct","%cI","%cs","%d","%D","%S","%e","%s"],s=i.default.exec(`git log${r?' -"'+r+'"':""}${a?' --since="'+function(e){const a=String(e).match(/^(\d+)([a-zA-Z]+)$/);let r;if(!a)return null;switch(r=+a[1],a[2]){case"m":r*=60;break;case"h":r*=3600;break;case"d":r*=86400;break;case"w":r*=604800;break;case"M":r*=2592e3;break;case"y":r*=31536e3}return parseInt(String(Date.now()/1e3-r))}(a)+'"':""}${t?' --branches="*'+t+'"':""} --date-order --pretty=format:"${n.join(",=")}-end-"`,{silent:!0}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,"");let c=[];return s&&s.split("-end-").forEach((e=>{let a=e.split(",="),r={};n.forEach(((e,t)=>{r[e]=a[t]})),c.push(r)})),c}var o;i.default.exec("git rev-parse --is-inside-work-tree",{silent:!0}).stdout.includes("true")||(i.default.echo((o="当前目录不是git项目目录",n.default.red(o))),i.default.exit(1)),e.program.name("gitm log").usage("[branche]").description("日志查询"),s.length>0&&e.program.arguments(function(e){let a=[];return e.forEach((e=>{let r=e.name;e.variadic&&(r+="..."),r=e.required?"<"+r+">":"["+r+"]",a.push(r)})),a.join(" ")}(s)),c.forEach((a=>{e.program.option(a.flags,a.description,a.defaultValue)})),e.program.action((async(e,a)=>{const r=l({lastet:a.lastet,limit:a.limit,branches:e});console.log(r),i.default.exit(1)})),e.program.parse(process.argv);
