#!/usr/bin/env node
"use strict";"undefined"!=typeof require&&require;const{program:e}=require("commander"),r=require("inquirer"),t=require("shelljs"),{options:o,args:c}=require("./conf/redo"),{error:i,warning:s,queue:a,isGitProject:n}=require("./js/index"),{createArgs:u}=require("./js/tools");n()||(t.echo(i("当前目录不是git项目目录")),t.exit(1)),e.name("gitm redo").usage("[commitid...] [-b --branch [branch]] [-m --mode [mode]]").description("撤销一次提交记录"),c.length>0&&e.arguments(u(c)),o.forEach((r=>{e.option(r.flags,r.description,r.defaultValue)})),e.action(((e,o)=>{return c=void 0,i=null,n=function*(){const c=[];let i="";if(o.mode&&(i=" -m "+Math.abs(Number(o.mode))),o.branch){const e=["%H","%aI","%an"],s=t.exec(`git log --merges --grep="'${o.branch}'" --date-order --pretty=format:"${e.join(",=")}-end-"`,{silent:!0}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,""),a=[];let n=a.map((e=>e["%H"]));if(s&&s.split("-end-").forEach((r=>{const t=r.split(",="),o={};e.forEach(((e,r)=>{o[e]=t[r]})),a.push(o)})),a.reverse(),a.length>1){const e={type:"checkbox",message:"检测到存在多条记录，请选择要撤销的项",name:"commitIDs",choices:[]};a.forEach((r=>{e.choices.push({name:`${r["%an"]}操作于：${r["%aI"]}`,value:r["%H"],checked:!0})}));const{commitIDs:t}=yield r.prompt(e);n=t}n.forEach((e=>{c.push({cmd:`git revert ${e}${i}`,config:{again:!0,success:"撤销成功",fail:"出错了，请根据提示处理"}})}))}else e?c.push({cmd:`git revert ${e}${i}`,config:{again:!0,success:"撤销成功",fail:"出错了，请根据提示处理"}}):(t.echo(s("指令不合法")),t.exit(1));a(c)},new Promise(((e,r)=>{var t=e=>{try{s(n.next(e))}catch(e){r(e)}},o=e=>{try{s(n.throw(e))}catch(e){r(e)}},s=r=>r.done?e(r.value):Promise.resolve(r.value).then(t,o);s((n=n.apply(c,i)).next())}));var c,i,n})),e.parse(process.argv);
