#!/usr/bin/env node
"use strict";function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}var program=require("commander");var inquirer=require("inquirer");var sh=require("shelljs");var _require=require("./conf/redo"),options=_require.options,args=_require.args;var _require2=require("./js/index"),warning=_require2.warning,queue=_require2.queue;var _require3=require("./js/tools"),createArgs=_require3.createArgs;program.name("gitm redo").usage("[commitid...] [-b --branch [branch]] [-m --mode [mode]]").description("撤销一次提交记录");if(args.length>0)program.arguments(createArgs(args));options.forEach(function(o){program.option(o.flags,o.description,o.defaultValue)});program.action(function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(commitid,opt){var cmd,m,keys,results,logList,logs,prompt,_yield$inquirer$promp,commitIDs;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:cmd=[],m="";if(opt.mode)m=" -m "+Math.abs(Number(opt.mode));if(!opt.branch){_context.next=19;break}keys=["%H","%aI","%an"];results=sh.exec("git log --merges --grep=\"'".concat(opt.branch,'\'" --date-order --pretty=format:"').concat(keys.join(",="),'-end-"'),{silent:true}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,"");logList=[],logs=logList.map(function(log){return log["%H"]});results&&results.split("-end-").forEach(function(log){var args=log.split(",="),map={};keys.forEach(function(key,i){map[key]=args[i]});logList.push(map)});logList.reverse();if(!(logList.length>1)){_context.next=16;break}prompt={type:"checkbox",message:"检测到存在多条记录，请选择要撤销的项",name:"commitIDs",choices:[]};logList.forEach(function(log){prompt.choices.push({name:"".concat(log["%an"],"操作于：").concat(log["%aI"]),value:log["%H"],checked:true})});_context.next=13;return inquirer.prompt(prompt);case 13:_yield$inquirer$promp=_context.sent;commitIDs=_yield$inquirer$promp.commitIDs;logs=commitIDs;case 16:logs.forEach(function(log){cmd.push({cmd:"git revert ".concat(log).concat(m),config:{slient:false,again:true,success:"撤销成功",fail:"出错了，请根据提示处理"}})});_context.next=20;break;case 19:if(commitid){cmd.push({cmd:"git revert ".concat(commitid).concat(m),config:{slient:false,again:true,success:"撤销成功",fail:"出错了，请根据提示处理"}})}else{sh.echo(warning("指令不合法"));sh.exit(1)}case 20:queue(cmd);case 21:case"end":return _context.stop()}}},_callee)}));return function(_x,_x2){return _ref.apply(this,arguments)}}());program.parse(process.argv);