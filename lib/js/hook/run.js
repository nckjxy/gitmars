"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("child_process"),s=require("fs"),t=require("shelljs"),o=require("slash"),r=require("cosmiconfig");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=i(s),c=i(t),a=i(o);function p(...e){["1","true"].includes(process.env.HUSKY_DEBUG||"")&&console.info("gitmars:debug",...e)}const u={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};const l=function(e,s="gitmars"){let t;if(!e){let{root:s}=function(e=process.cwd()){const s=c.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[t,o,r,i,n=""]=s.split("\n").map((e=>e.trim())).map(a.default);return{prefix:o||".",gitCommonDir:r,root:t,gitDir:i,gitHookDir:i+"/hooks",cdup:n}}();try{e=s+"/gitmarsconfig.json",t=n.default.statSync(e)}catch(t){e=s}}const o={skipCI:!0},i=r.cosmiconfigSync(s);if(t||(t=n.default.statSync(e)),t.isDirectory()){const{config:s={},filepath:t=""}=i.search(e)||{};return Object.assign({},u,o,s,{filepath:t})}{const{config:s={},filepath:t=""}=i.load(e)||{};return Object.assign({},u,o,s,{filepath:t})}}();function f(e,s){return l&&l.hooks&&l.hooks[s]}function d(s,t,o,r){console.info(`gitmars > ${t} (node ${process.version})`);const{status:i}=e.spawnSync("sh",["-c",o],{cwd:s,env:Object.assign(Object.assign({},process.env),r),stdio:"inherit"});if(0!==i){const e=["commit-msg","pre-commit","pre-rebase","pre-push"].includes(t)?"(add --no-verify to bypass)":"(cannot be bypassed with --no-verify due to Git specs)";console.info(`gitmars > ${t} hook failed ${e}`)}return 127===i?1:i||0}function g([,,e="",...s],{cwd:t=process.cwd()}={}){const o=f(0,e),r={};return(null==s?void 0:s.length)&&(r.GITMARS_GIT_PARAMS=s.join(" ")),o?d(t,e,o,r):0}exports.default=async function(){process.env.GIT_DIR&&(p(`GIT_DIR 环境变量值为：${process.env.GIT_DIR}`),p('如果提示"fatal: not a git repository"，请检查 GIT_DIR 的值'));try{const e=await g(process.argv);process.exit(e)}catch(e){console.info("Gitmars > 未知错误！请联系吴峰",e),process.exit(1)}},exports.getCommand=f,exports.runCommand=d,exports.start=g;
