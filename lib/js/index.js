"use strict";function _createForOfIteratorHelper(o,allowArrayLike){var it=typeof Symbol!=="undefined"&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&typeof o.length==="number"){if(it)o=it;var i=0;var F=function F(){};return{s:F,n:function n(){if(i>=o.length)return{done:true};return{done:false,value:o[i++]}},e:function e(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var normalCompletion=true,didErr=false,err;return{s:function s(){it=it.call(o)},n:function n(){var step=it.next();normalCompletion=step.done;return step},e:function e(_e2){didErr=true;err=_e2},f:function f(){try{if(!normalCompletion&&it.return!=null)it.return()}finally{if(didErr)throw err}}}}function _unsupportedIterableToArray(o,minLen){if(!o)return;if(typeof o==="string")return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);if(n==="Object"&&o.constructor)n=o.constructor.name;if(n==="Map"||n==="Set")return Array.from(o);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}function _arrayLikeToArray(arr,len){if(len==null||len>arr.length)len=arr.length;for(var i=0,arr2=new Array(len);i<len;i++){arr2[i]=arr[i]}return arr2}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}var fs=require("fs");var sh=require("shelljs");var colors=require("colors");var getGitConfig=require("./getGitConfig");var gitRevParse=require("./gitRevParse");var getConfig=require("./getConfig");function warning(txt){return colors.yellow(txt)}function error(txt){return colors.red(txt)}function success(txt){return colors.green(txt)}function writeFile(url,data){return new Promise(function(resolve,reject){fs.writeFile(url,data,function(err){if(err){reject(new Error("文件写入错误"))}else{resolve()}})})}function mapTemplate(tmp,data){if(!tmp||!data)return null;var str=""+tmp.replace(/\$\{([a-zA-Z0-9-_]+)\}/g,function(a,b){if(typeof data==="function"){return data(b)}for(var k in data){if(b===k){return data[k]}}});return str}function getSeconds(str){var match=String(str).match(/^(\d+)([a-zA-Z]+)$/),time;if(!match)return null;time=+match[1];switch(match[2]){case"m":time*=60;break;case"h":time*=3600;break;case"d":time*=86400;break;case"w":time*=604800;break;case"M":time*=2592e3;break;case"y":time*=31536e3;break;default:break}return parseInt(Date.now()/1e3-time)}function wait(list,fun){if(list.length===0){fun();return}else{fun(list[0],function(){var kill=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(kill)return;list.shift();wait(list,fun)})}}function queue(list){return new Promise(function(resolve,reject){var returns=[];if(list.length===0)reject("指令名称不能为空");list=JSON.parse(JSON.stringify(list));wait(list,function(command,cb){var cfg={silent:true,postmsg:false,kill:true,again:false},cmd=command;if(command instanceof Object){cfg=Object.assign(cfg,command.config||{});cmd=command.cmd}if(!cmd){resolve(returns)}else{sh.exec(cmd,cfg,function(code,out,err){var msg=getCommandMessage(cmd);try{out=JSON.parse(out)}catch(err){out=out.replace(/\n*$/g,"")}returns.push({code:code,out:out,err:err,cfg:cfg,cmd:cmd});if(code!==0)setLog({command:command,code:code,out:out,err:err});if(code!==0&&cfg.kill){var rest=JSON.parse(JSON.stringify(list));if(!cfg.again){rest.shift()}else if(cfg.again!==true){rest.splice(0,1,cfg.again)}cb(true);setCache(rest);cfg.silent&&sh.echo(error(err));sh.echo(error(cfg.fail||msg.fail||"出错了！指令 "+cmd+" 执行失败，中断了进程"));cfg.postmsg&&postMessage("出错了！指令 "+cmd+" 执行失败，中断了进程");rest.length>0&&sh.echo(error("请处理相关问题之后输入gitm continue继续"));sh.exit(1)}else{if(code===0){var m=cfg.success||msg.success;if(m){sh.echo(success(m));cfg.postmsg&&postMessage(m)}}else{var _m=cfg.fail||msg.fail||"指令 "+cmd+" 执行失败";_m&&sh.echo(warning(_m))}cb()}})}})})}function getCache(){var _gitRevParse=gitRevParse(),gitDir=_gitRevParse.gitDir;var arr=[];if(sh.test("-f",gitDir+"/.gitmarscommands")){arr=sh.cat(gitDir+"/.gitmarscommands").stdout.split("\n")[0].replace(/(^\n*)|(\n*$)/g,"").replace(/\n{2,}/g,"\n").replace(/\r/g,"");arr=JSON.parse(decodeURIComponent(arr))}return arr}function setCache(rest){var _gitRevParse2=gitRevParse(),gitDir=_gitRevParse2.gitDir;sh.touch(gitDir+"/.gitmarscommands");sh.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(rest)),gitDir+"/.gitmarscommands")}function setLog(log){var _gitRevParse3=gitRevParse(),gitDir=_gitRevParse3.gitDir;sh.touch(gitDir+"/.gitmarslog");sh.sed("-i",/[\s\S\n\r\x0a\x0d]*/,encodeURIComponent(JSON.stringify(log)),gitDir+"/.gitmarslog")}var getStatusInfo=function getStatusInfo(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var _config$silent=config.silent,silent=_config$silent===void 0?true:_config$silent;var out=sh.exec("git status -s --no-column",{silent:silent}).stdout.replace(/(^\s+|\n*$)/g,"");var list=out?out.replace(/\n(\s+)/g,"\n").split("\n"):[],sum={A:[],D:[],M:[],"??":[]};if(list.length===0)return sum;list.forEach(function(str){var arr=str.trim().replace(/\s+/g," ").split(" "),type=arr.splice(0,1);if(!sum[type])sum[type]=[];sum[type].push(arr.join(" "))});return sum};function getStatus(){var sum=getStatusInfo({silent:false});if(sum.A.length>0||sum.D.length>0||sum.M.length>0){sh.echo(error("您还有未提交的文件，请处理后再继续")+"\n如果需要暂存文件请执行: gitm save\n恢复时执行：gitm get");sh.exit(1);return false}else if(sum["??"].length>0){sh.echo(warning("您有未加入版本的文件,")+"\n如果需要暂存文件请执行: gitm save --force\n恢复时执行：gitm get")}return true}function getLogs(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var lastet=config.lastet,limit=config.limit,branches=config.branches;var keys=["%H","%T","%P","%an","%ae","%al","%aL","%ad","%ar","%at","%aI","%as","%cn","%ce","%cl","%cL","%cd","%cr","%ct","%cI","%cs","%d","%D","%S","%e","%s"];var results=sh.exec("git log".concat(limit?' -"'+limit+'"':"").concat(lastet?' --since="'+getSeconds(lastet)+'"':"").concat(branches?' --branches="*'+branches+'"':"",' --date-order --pretty=format:"').concat(keys.join(",="),'-end-"'),{silent:true}).stdout.replace(/[\r\n]+/g,"").replace(/-end-$/,"");var logList=[];results&&results.split("-end-").forEach(function(log){var args=log.split(",="),map={};keys.forEach(function(key,i){map[key]=args[i]});logList.push(map)});return logList}var checkBranch=function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(name){var data;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return queue(["gitm branch -k ".concat(name)]);case 2:data=_context.sent;return _context.abrupt("return",data[0].out.replace(/^\s+/,""));case 4:case"end":return _context.stop()}}},_callee)}));return function checkBranch(_x){return _ref.apply(this,arguments)}}();function getCurrent(){return sh.exec("git symbolic-ref --short -q HEAD",{silent:true}).stdout.replace(/[\n\s]*$/g,"")}var searchBranch=function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(key,type){var remote,data,arr,_args2=arguments;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:remote=_args2.length>2&&_args2[2]!==undefined?_args2[2]:false;_context2.next=3;return queue(["gitm branch".concat(key?" -k "+key:"").concat(type?" -t "+type:"").concat(remote?" -r":"")]);case 3:data=_context2.sent[0].out.replace(/^\*\s+/,"");arr=data?data.split("\n"):[];arr=arr.map(function(el){return el.trim()});return _context2.abrupt("return",arr);case 7:case"end":return _context2.stop()}}},_callee2)}));return function searchBranch(_x2,_x3){return _ref2.apply(this,arguments)}}();var searchBranchs=function searchBranchs(){var opt=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var path=opt.path,key=opt.key,type=opt.type,_opt$remote=opt.remote,remote=_opt$remote===void 0?false:_opt$remote;if(!path)path=sh.pwd().stdout;var data=sh.exec("git ls-remote".concat(remote?" --refs":" --heads",' --quiet --sort="version:refname" ').concat(path),{silent:true}).stdout.replace(/\n*$/g,"");var arr=data?data.split("\n"):[],map={heads:[],tags:[],others:[]};var _iterator=_createForOfIteratorHelper(arr),_step;try{for(_iterator.s();!(_step=_iterator.n()).done;){var el=_step.value;var match=el.match(/^\w+[\s]+refs\/(heads|remotes|tags)\/([\w-\/]+)$/);if(!match)continue;switch(match[1]){case"heads":map.heads.push(match[2]);break;case"remotes":map.heads.push(match[2]);break;case"tags":map.tags.push(match[2]);break;default:map.others.push(match[2]);break}}}catch(err){_iterator.e(err)}finally{_iterator.f()}if(type&&["bugfix","feature","support"].includes(type)){map.heads=map.heads.filter(function(el){return el.indexOf("/"+type+"/")>-1})}if(key){map.heads=map.heads.filter(function(el){return el.indexOf(key)>-1})}return map.heads};var filterBranch=function filterBranch(key){var types=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var remote=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;if(typeof types==="string")types=types.split(",");var out=sh.exec("git branch".concat(remote?" -a":""),{silent:true}).stdout.replace(/(^\s+|[\n\r]*$)/g,"").replace(/\*\s+/,"");var list=out?out.replace(/\n(\s+)/g,"\n").split("\n"):[];list=list.filter(function(el){var result=true;if(key&&!el.includes(key))result=false;if(result&&types.length>0){result=false;var _iterator2=_createForOfIteratorHelper(types),_step2;try{type:for(_iterator2.s();!(_step2=_iterator2.n()).done;){var type=_step2.value;if(el.includes(type)){result=true;break type}}}catch(err){_iterator2.e(err)}finally{_iterator2.f()}}return result});return list};var getStashList=function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(key){var data,list,arr;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return queue(["git stash list"]);case 2:data=_context3.sent[0].out.replace(/^\*\s+/,"");list=data&&data.split("\n")||[],arr=[];if(list.length>10)sh.echo(warning("该项目下一共有".concat(list.length,"条暂存记录，建议定期清理！")));try{list.forEach(function(item){var msgArr=item.split(":"),first=msgArr.shift();if(!key||key&&key===msgArr[msgArr.length-1].trim()){var m=first.match(/^stash@\{(\d+)\}$/);if(msgArr.length>1)msgArr.shift();arr.push({key:first,index:+m[1],msg:msgArr.join(":").trim()})}})}catch(e){}return _context3.abrupt("return",arr);case 7:case"end":return _context3.stop()}}},_callee3)}));return function getStashList(_x4){return _ref3.apply(this,arguments)}}();function getMessage(type){var _gitRevParse4=gitRevParse(),root=_gitRevParse4.root;var _getGitConfig=getGitConfig(),appName=_getGitConfig.appName;var config=getConfig();var str="",d=new Date;switch(type){case"time":str=d;break;case"timeNum":str=d.getTime();break;case"pwd":str=root;break;case"project":str=appName;break;case"user":str=config.user;break;default:break}return str}function postMessage(msg){var config=getConfig();if(!config.msgTemplate){sh.echo(error("请配置消息发送api模板地址"));return}var message=mapTemplate(config.msgTemplate,function(key){if(key==="message")return msg;return getMessage(key)});config.msgUrl&&sendMessage(message)}var sendMessage=function sendMessage(message){var cfg=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var config=getConfig();var _cfg$silent=cfg.silent,silent=_cfg$silent===void 0?true:_cfg$silent;if(!config.msgUrl){sh.echo(error("请配置消息推送地址"));return}message=message.replace(/\s/g,"");config.msgUrl&&sh.exec('curl -i -H "Content-Type: application/json" -X POST -d \'{"envParams":{"error_msg":"\''.concat(message,"'\"}}' \"").concat(config.msgUrl,'"'),{silent:silent})};function getCommandMessage(cmd){var msg={},arr=cmd.replace(/[\s]+/g," ").split(" ");if(arr.length<2||arr[0]!=="git")return msg;switch(arr[1]){case"checkout":msg.success="切换分支成功";msg.fail="切换分支失败";break;case"pull":msg.success="拉取代码成功";msg.fail="拉取代码失败";break;case"fetch":msg.success="抓取成功";msg.fail="抓取失败";break;case"commit":msg.success="提交成功";msg.fail="提交失败";break;case"push":msg.success="推送成功";msg.fail="推送失败";break;case"cherry-pick":msg.success="同步提交记录成功";msg.fail="同步提交记录失败";break;case"merge":msg.success="merge分支成功";msg.fail="merge分支失败";break;case"rebase":msg.success="rebase分支成功";msg.fail="rebase分支失败";break;case"revert":msg.success="撤销成功";msg.fail="撤销失败";break;case"clean":msg.success="清理成功";msg.fail="清理失败";break;default:break}return msg}function compareVersion(basicVer,compareVer){if(basicVer===null)return null;basicVer=basicVer+".";compareVer=compareVer+".";var bStr=parseFloat(basicVer),cStr=parseFloat(compareVer),bStrNext=parseFloat(basicVer.replace(bStr+".",""))||0,cStrNext=parseFloat(compareVer.replace(cStr+".",""))||0;if(cStr>bStr){return false}else if(cStr<bStr){return true}else{if(bStrNext>=cStrNext){return true}else{return false}}}function getBranchsFromID(commitID){var remote=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var out=sh.exec("git branch ".concat(remote?"-r":""," --contains ").concat(commitID,' --format="%(refname:short)'),{silent:true}).stdout.replace(/(^\s+|\n*$)/g,"");return out?out.split("\n"):[]}function getGitUser(){return sh.exec("git config user.name",{silent:true}).stdout.replace(/(^\s+|\n*$)/g,"")}function getGitEmail(){return sh.exec("git config user.email",{silent:true}).stdout.replace(/(^\s+|\n*$)/g,"")}module.exports={warning:warning,error:error,success:success,writeFile:writeFile,mapTemplate:mapTemplate,getSeconds:getSeconds,wait:wait,queue:queue,getCache:getCache,setCache:setCache,setLog:setLog,getStatusInfo:getStatusInfo,getStatus:getStatus,getLogs:getLogs,checkBranch:checkBranch,getCurrent:getCurrent,searchBranch:searchBranch,searchBranchs:searchBranchs,filterBranch:filterBranch,getStashList:getStashList,postMessage:postMessage,sendMessage:sendMessage,getCommandMessage:getCommandMessage,compareVersion:compareVersion,getBranchsFromID:getBranchsFromID,getGitUser:getGitUser,getGitEmail:getGitEmail};