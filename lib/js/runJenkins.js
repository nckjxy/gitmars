"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("shelljs"),t=require("path"),i=require("fs"),o=require("colors"),r=require("slash"),n=require("cosmiconfig");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var l=a(e),s=a(t),u=a(i),f=a(o),c=a(r);const p={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};function d(e,t="gitmars"){let i;if(!e){let{root:t}=function(e=process.cwd()){const t=l.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[i,o,r,n,a=""]=t.split("\n").map((e=>e.trim())).map(c.default);return{prefix:o||".",gitCommonDir:r,root:i,gitDir:n,gitHookDir:n+"/hooks",cdup:a}}();try{e=t+"/gitmarsconfig.json",i=u.default.statSync(e)}catch(i){e=t}}const o={skipCI:!0},r=n.cosmiconfigSync(t);if(i||(i=u.default.statSync(e)),i.isDirectory()){const{config:t={},filepath:i=""}=r.search(e)||{};return Object.assign({},p,o,t,{filepath:i})}{const{config:t={},filepath:i=""}=r.load(e)||{};return Object.assign({},p,o,t,{filepath:i})}}function g(e){return f.default.red(e)}function m(e,t){return new Promise(((i,o)=>{u.default.writeFile(e,t,(e=>{e?o(new Error("文件写入错误")):i(!0)}))}))}let h=require("node-apollo"),v=require("shelljs");const j=s.default.join(__dirname,"../../cache");exports.default=async function({env:e,project:t,app:i="all"}){let o,r,n=await async function(){let e,t,i,o=(new Date).getTime();if(v.test("-f",j+"/buildConfig.json")&&o-parseInt(v.cat(j+"/buildConfig.txt").stdout)<864e5)return require(j+"/buildConfig.json");if(e=d(),!e.apolloConfig)return v.echo(g("请配置apollo")),void v.exit(0);if("string"==typeof e.apolloConfig)try{t=JSON.parse(e.apolloConfig)}catch{return}else t=e.apolloConfig;return i=await h.remoteConfigService(t),await m(j+"/buildConfig.txt",String(o)),await m(j+"/buildConfig.json",JSON.stringify(i.content)),i.content}(),a=n[e];return a?(o=a.list.find((e=>e.name===t)),o?i&&o.apps&&!o.apps.includes(i)?(l.default.echo(g("请输入正确的应用名称")),void l.default.exit(1)):n.template?(s=o.apps&&o.apps.length>0?n.templateWithParam:n.template,u={line:a.line,project:o.project,token:a.token,app:i},r=s&&u?""+s.replace(/\$\{([a-zA-Z0-9-_]+)\}/g,((e,t)=>{if("function"==typeof u)return u(t);for(let e in u)if(t===e)return u[e]})):null,l.default.exec(`curl -u ${n.username}:${n.password} "${r}"`,{silent:!0}),void l.default.echo((c="成功调起Jenkins构建",f.default.green(c)))):(l.default.echo(g("请配置Jenkins构建地址模板")),void l.default.exit(1)):(l.default.echo(g("请输入正确的项目名称")),void l.default.exit(1))):(l.default.echo(g("请输入正确的环境名称")),void l.default.exit(1));var s,u,c};
