"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("shelljs"),t=require("fs"),s=require("colors"),o=require("slash"),r=require("cosmiconfig");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=i(e),c=i(t),n=i(s),l=i(o);const u={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};function p(e,t="gitmars"){let s;if(!e){let{root:t}=function(e=process.cwd()){const t=a.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[s,o,r,i,c=""]=t.split("\n").map((e=>e.trim())).map(l.default);return{prefix:o||".",gitCommonDir:r,root:s,gitDir:i,gitHookDir:i+"/hooks",cdup:c}}();try{e=t+"/gitmarsconfig.json",s=c.default.statSync(e)}catch(s){e=t}}const o={skipCI:!0},i=r.cosmiconfigSync(t);if(s||(s=c.default.statSync(e)),s.isDirectory()){const{config:t={},filepath:s=""}=i.search(e)||{};return Object.assign({},u,o,t,{filepath:s})}{const{config:t={},filepath:s=""}=i.load(e)||{};return Object.assign({},u,o,t,{filepath:s})}}function f(e){return n.default.red(e)}exports.getUserToken=function(){const e=p();e.api||(a.default.echo(f("请配置用于请求权限的api接口地址，接收参数形式：url?name=git_user_name，返回data=token")),process.exit(1));const t=a.default.exec("git config user.name",{silent:!0}).stdout.replace(/(^\s+|\n*$)/g,"");t||(a.default.echo(f("请设置本地git用户名")),process.exit(1));let s,o=a.default.exec(`curl -s ${e.api}?name=${t}`,{silent:!0}).stdout;try{o=JSON.parse(o),s=o.data||null}catch(e){s=null}return s?s.token||(a.default.echo(f("请设置access_token")),process.exit(1)):(a.default.echo(f("没有找到用户，请联系管理员")),process.exit(1)),s};
