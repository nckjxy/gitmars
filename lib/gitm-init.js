#!/usr/bin/env node
"use strict";var e=require("commander"),t=require("fs"),r=require("shelljs"),s=require("inquirer"),a=require("colors"),o=require("slash");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}require("cosmiconfig");var n=i(t),p=i(r),l=i(s),u=i(a),m=i(o);const g={master:"master",develop:"dev",release:"release",bugfix:"bug",support:"support",user:"",email:"",msgTemplate:"${message}；项目：${project}；路径：${pwd}",msgUrl:"",apolloConfig:"",hooks:"",api:"",gitHost:"",gitID:""};var f;p.default.exec("git rev-parse --is-inside-work-tree",{silent:!0}).stdout.includes("true")||(p.default.echo((f="当前目录不是git项目目录",u.default.red(f))),p.default.exit(1));const{root:c}=function(e=process.cwd()){const t=p.default.exec("git rev-parse --show-toplevel --show-prefix --git-common-dir --absolute-git-dir --show-cdup",{silent:!0}).stdout.replace(/[\s]*$/g,""),[r,s,a,o,i=""]=t.split("\n").map((e=>e.trim())).map(m.default);return{prefix:s||".",gitCommonDir:a,root:r,gitDir:o,gitHookDir:o+"/hooks",cdup:i}}();e.program.name("gitm init").usage("").description("设置gitmars的配置项").action((()=>{let e=[];Object.keys(g).forEach((t=>{["master","develop","release","bugfix","support"].includes(t)?e.push({type:"input",name:t,message:`请输入${t}分支名称`,default:()=>t,transformer:(e,t,r)=>e.trim(),validate:e=>!!/^\w+$/.test(e)||"请输入可用名称"}):"user"===t?e.push({type:"input",name:t,message:"请输入Git用户名",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^\w+$/.test(e))||"请输入可用名称"}):"email"===t?e.push({type:"input",name:t,message:"请输入Git邮箱",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test(e))||"请输入正确的邮箱"}):"msgTemplate"===t?e.push({type:"input",name:t,message:"请输入消息模板",default:()=>"${message}；项目：${project}；路径：${pwd}",transformer:(e,t,r)=>e.trim()}):"msgUrl"===t?e.push({type:"input",name:t,message:"请输入云之家消息推送地址",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^https?:\/\/[\S]*$/.test(e))||"请输入网址"}):"apolloConfig"===t?e.push({type:"editor",name:t,message:"请输入apollo配置",default:()=>'{\n    "configServerUrl": "",\n    "appId": "",\n    "clusterName": "",\n    "namespaceName": [],\n    "apolloEnv": "",\n    "token": ""\n}',validate:e=>{try{return e=JSON.parse(e),!0}catch(e){return"请输入json"}}}):"hooks"===t?e.push({type:"editor",name:t,message:"请输入hooks配置",default:()=>'{\n    "pre-commit": "",\n    "pre-push": ""\n}',validate:e=>{try{return e=JSON.parse(e),!0}catch(e){return"请输入json"}}}):"api"===t?e.push({type:"input",name:t,message:"请输入查询用户权限接口",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^https?:\/\/[\S]*$/.test(e))||"请输入网址"}):"gitHost"===t?e.push({type:"input",name:t,message:"请输入git网址",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^https?:\/\/[\S]*$/.test(e))||"请输入网址"}):"gitID"===t&&e.push({type:"input",name:t,message:"请输入git项目ID，目前仅支持gitlab",transformer:(e,t,r)=>e.trim(),validate:e=>!(""!==e&&!/^\d+$/.test(e))||"请输入网址"})})),l.default.prompt(e).then((e=>{try{e.apolloConfig=JSON.parse(e.apolloConfig),e.apolloConfig.configServerUrl&&e.apolloConfig.token||(e.apolloConfig="")}catch(t){e.apolloConfig=""}try{let t=!1;e.hooks=JSON.parse(e.hooks);e:for(let r in e.hooks)if(e.hooks[r]){t=!0;break e}t||(e.hooks="")}catch(t){e.hooks=""}p.default.echo(function(e){return u.default.green(e)}("gitmars配置成功")),n.default.writeFileSync(c+"/.gitmarsrc",JSON.stringify(e,null,4),"utf-8"),n.default.chmodSync(c+"/.gitmarsrc",493)}))})),e.program.parse(process.argv);
