#!/usr/bin/env node
const program=require("commander");const sh=require("shelljs");const{options,args}=require("./conf/update");const{error,queue,getStatus,getCurrent,filterBranch,isGitProject}=require("./js/index");const{createArgs}=require("./js/tools");if(!isGitProject()){sh.echo(error("当前目录不是git项目目录"));sh.exit(1)}const config=require("./js/getConfig")();const{defaults}=require("./js/global");program.name("gitm update").usage("[type] [name]").description("更新bug任务分支、更新feature功能开发分支、框架调整分支support");if(args.length>0)program.arguments(createArgs(args));options.forEach(o=>{program.option(o.flags,o.description,o.defaultValue)});program.action((type,name,opt)=>{const allow=["bugfix","feature","support"];const deny=[defaults.master,defaults.develop,defaults.release,defaults.bugfix,defaults.support];let status=getStatus(),cmds=[],branchList=[];if(!status)sh.exit(1);if(opt.all){if(!type)type=allow;branchList=filterBranch("",type)}else if(!type||!name){const current=getCurrent();[type,name]=current.split("/");if(!name){deny.includes(type)&&sh.echo(error(`\u9A9A\u5E74\uFF0C\u4F60\u5728${type}\u5206\u652F\u6267\u884C\u8FD9\u4E2A\u6307\u4EE4\u662F\u4EC0\u4E48\u9A9A\u64CD\u4F5C\uFF1F`));sh.exit(1)}if(!allow.includes(type)){sh.echo(error("type只允许输入："+JSON.stringify(allow)));sh.exit(1)}branchList=[].concat(current)}else if(!allow.includes(type)){sh.echo(error("type只允许输入："+JSON.stringify(allow)));sh.exit(1)}else{branchList=[type+"/"+name]}branchList.forEach(branch=>{[type,name]=branch.split("/");let base=type==="bugfix"?config.bugfix:type==="support"?config.master:config.release,cmd=[`git fetch`,`git checkout ${base}`,`git pull`,`git checkout ${type}/${name}`];if(opt.useRebase){cmd.push({cmd:`git rebase ${base}`,config:{slient:false,again:false,success:`${base}\u66F4\u65B0\u5230${type}/${name}\u6210\u529F`,fail:`${base}\u66F4\u65B0\u5230${type}/${name}\u51FA\u9519\u4E86\uFF0C\u8BF7\u6839\u636E\u63D0\u793A\u5904\u7406`}})}else{cmd.push({cmd:`git merge --no-ff ${base}`,config:{slient:false,again:false,success:`${base}\u540C\u6B65\u5230${type}/${name}\u6210\u529F`,fail:`${base}\u540C\u6B65\u5230${type}/${name}\u51FA\u9519\u4E86\uFF0C\u8BF7\u6839\u636E\u63D0\u793A\u5904\u7406`}})}cmds=cmds.concat(cmd)});queue(cmds)});program.parse(process.argv);