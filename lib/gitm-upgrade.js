#!/usr/bin/env node
"use strict";const{program:s}=require("commander"),{spawnSync:r}=require("child_process"),e=require("shelljs"),{options:t,args:i}=require("./conf/upgrade"),{success:o}=require("./js/index"),{createArgs:a}=require("./js/tools"),n=require("ora");s.name("gitm upgrade").usage("[version]").description("升级gitmars"),i.length>0&&s.arguments(a(i)),t.forEach((r=>{s.option(r.flags,r.description,r.defaultValue)})),s.action((async(s,t)=>{const i=n(o("正在安装请稍后")).start(),a=s&&s.match(/[0-9.]+$/)||null,c=["npm",["install","-g",`gitmars@${a?a[0]:"latest"}`]],l=["npm",["uninstall","-g","gitmars"]];t.mirror&&(c[1]=c[1].concat(["-registry","https://registry.npm.taobao.org"]));0!==r(l[0],l[1],{stdio:"inherit",shell:"win32"===process.platform}).status&&(console.warn("卸载出错了"),process.exit(0));const p=r(c[0],c[1],{stdio:"inherit",shell:"win32"===process.platform});r("gitm",["-v"],{stdio:"inherit",shell:"win32"===process.platform}),e.echo(`\n${o("安装完成")}`),i.stop(),0===p.status||console.warn("安装出错了"),process.exit(0)})),s.parse(process.argv);
